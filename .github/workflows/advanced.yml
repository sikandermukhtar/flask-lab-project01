name: Advanced CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_NAME: "hospital-management-system"

jobs:
  test:
    runs-on: ubuntu-latest
    name: "Test"
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        pytest tests/ -v

  build:
    runs-on: ubuntu-latest
    name: "Build Docker"
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t ${{ env.APP_NAME }}:latest .
    
    - name: Push to Docker Hub
      if: ${{ secrets.DOCKER_USERNAME != '' && secrets.DOCKER_PASSWORD != '' && github.ref == 'refs/heads/main' }}
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
        docker tag ${{ env.APP_NAME }}:latest ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:latest

  deploy:
    runs-on: ubuntu-latest
    name: "Deploy"
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: AWS Deploy
      if: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}
      run: |
        echo "Deploying to AWS..."
        echo "AWS Access Key: Available"
    
    - name: Skip AWS (no credentials)
      if: ${{ secrets.AWS_ACCESS_KEY_ID == '' }}
      run: |
        echo "Skipping AWS deployment - no credentials"
        echo "Set AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY secrets"

  monitoring:
    runs-on: ubuntu-latest
    name: "Monitoring"
    needs: deploy
    
    steps:
    - name: Deploy Grafana
      run: |
        echo "Grafana deployment commands would run here"
        echo "helm install grafana grafana/grafana --set admin.password='admin123'"

  final:
    runs-on: ubuntu-latest
    name: "Pipeline Complete"
    needs: [test, build, deploy, monitoring]
    
    steps:
    - name: Show status
      run: |
        echo "ðŸŽ‰ Pipeline completed!"
        echo ""
        echo "Test: ${{ needs.test.result }}"
        echo "Build: ${{ needs.build.result }}"
        echo "Deploy: ${{ needs.deploy.result }}"
        echo "Monitoring: ${{ needs.monitoring.result }}"